name: Validate Dotfiles

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install shellcheck and zsh
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck zsh

    - name: Install shfmt
      run: |
        curl -L -o shfmt https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64
        chmod +x shfmt
        sudo mv shfmt /usr/local/bin/

    - name: Validate shell scripts with shellcheck
      run: |
        echo "Checking shell scripts..."
        find . -name "*.sh" -not -path "./.git/*" -not -name ".functions.sh" | xargs shellcheck -e SC1091,SC2039

        echo "Checking other shell config files..."
        find . -name ".aliases.sh" -o -name ".paths.sh" | xargs shellcheck -e SC1091,SC2039

        echo "Checking zsh syntax with native zsh parser..."
        if command -v zsh >/dev/null 2>&1; then
          echo "  Checking zsh/.zshrc..."
          zsh -n zsh/.zshrc && echo "  ✅ zsh/.zshrc" || exit 1

          echo "  Checking zsh/.functions.sh..."
          zsh -n zsh/.functions.sh && echo "  ✅ zsh/.functions.sh" || exit 1

          echo "  Checking modular zsh configs..."
          if [ -d "zsh/.zshrc.d" ]; then
            find zsh/.zshrc.d -name "*.zsh" -type f | while read -r file; do
              zsh -n "$file" && echo "  ✅ $file" || exit 1
            done
          fi
        else
          echo "⚠️ zsh not available for syntax checking"
          exit 1
        fi

    - name: Check shell script formatting
      run: |
        echo "Checking shell script formatting..."
        find . -name "*.sh" -not -path "./.git/*" | xargs shfmt -d -i 4 -ci

        echo "Checking zsh config formatting..."
        find . -name ".aliases.sh" -o -name ".functions.sh" -o -name ".paths.sh" | xargs shfmt -d -i 4 -ci

    - name: Validate JSON files
      run: |
        echo "Checking JSON syntax..."
        find . -name "*.json" -not -path "./.git/*" | while read -r file; do
          echo "Validating $file"
          python3 -m json.tool "$file" > /dev/null
        done

    - name: Test init script syntax
      run: |
        echo "Testing init.sh syntax..."
        bash -n init.sh

    - name: Check for common issues
      run: |
        echo "Checking for common issues..."

        echo "Checking for hardcoded paths..."

        # Check for variable assignments with hardcoded /Users/ paths
        echo "  Checking variable assignments..."
        if grep -r '="/Users/' --include="*.sh" --include=".zshrc" --include=".functions.sh" --include=".aliases.sh" --include=".paths.sh" . | grep -v ".git" | grep -v "RANCHER" | grep -v '# ' | grep -v "example"; then
          echo "❌ Found hardcoded paths in variable assignments!"
          exit 1
        fi

        # Check for command usage with hardcoded /Users/ paths
        echo "  Checking command usage..."
        if grep -rE '(cd|source|\.)\s+/Users/' --include="*.sh" --include=".zshrc" --include=".functions.sh" --include=".aliases.sh" --include=".paths.sh" . | grep -v ".git" | grep -v "RANCHER" | grep -v '# ' | grep -v "documentation"; then
          echo "❌ Found hardcoded paths in commands!"
          exit 1
        fi

        echo "✅ No hardcoded paths found"

        echo "Checking for secrets in files..."
        # Look for actual secret patterns, not documentation about secrets
        if grep -r "password\s*=\s*[\"']\S\|secret\s*=\s*[\"']\S\|token\s*=\s*[\"']\S\|key\s*=\s*[\"']\S" --include="*.sh" --include=".zshrc" . | grep -v ".git" | grep -v "example" | grep -v "template" | grep -v "your_" | grep -v "github_token_here" | grep -v "ENC\["; then
          echo "❌ Potential secrets found!"
          exit 1
        else
          echo "✅ No secrets found in files"
        fi

        echo "Checking for TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" --include="*.sh" --include=".zshrc" --include="*.md" . | grep -v ".git"; then
          echo "ℹ️ Found TODO/FIXME comments (informational only)"
        fi

  macos-test:
    runs-on: macos-latest
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4

    - name: Test basic installation components
      run: |
        echo "Testing if required commands are available on macOS..."

        # Check if essential commands exist
        command -v zsh || echo "zsh not found (expected on base macOS)"
        command -v git || echo "git not found (expected on base macOS)"

        # Test Homebrew installation detection
        if command -v brew >/dev/null 2>&1; then
          echo "✅ Homebrew is installed"
        else
          echo "ℹ️ Homebrew not installed (expected in CI)"
        fi

        # Test zsh syntax
        echo "Testing zsh configuration syntax..."
        zsh -n zsh/.zshrc

        # Test functions syntax
        echo "Testing functions syntax..."
        bash -n zsh/.functions.sh

        # Test aliases syntax
        echo "Testing aliases syntax..."
        bash -n zsh/.aliases.sh

        # Test paths syntax
        echo "Testing paths syntax..."
        bash -n zsh/.paths.sh

    - name: Test installation script safety
      run: |
        echo "Testing init.sh safety checks..."

        # Test script can detect it's not in dotfiles directory
        mkdir -p test-dir
        cp init.sh test-dir/
        cd test-dir

        if ./init.sh --dry-run 2>&1 | grep -q "must be run from your dotfiles directory"; then
          echo "✅ Directory detection works"
        else
          echo "❌ Directory detection failed"
          exit 1
        fi
